<proxy xmlns="http://ws.apache.org/ns/synapse" name="vfs-proxy" transports="vfs">
    <parameter name="transport.vfs.FileURI">file:///data/IN</parameter>        
    <parameter name="transport.vfs.ContentType">text/plain</parameter>
    <parameter name="transport.vfs.FileNamePattern">.*\.csv</parameter>
    <parameter name="transport.PollInterval">5</parameter>
    <parameter name="transport.vfs.Streaming">true</parameter>
    <parameter name="transport.vfs.MoveAfterProcess">file:///data/IN/archive</parameter>            
    <parameter name="transport.vfs.MoveAfterFailure">file:///data/IN/fail</parameter>          
    <parameter name="transport.vfs.ActionAfterProcess">MOVE</parameter>
    <parameter name="transport.vfs.ActionAfterFailure">MOVE</parameter>
    <target>
         <inSequence>
            <property name="filename" expression="get-property('transport','FILE_NAME')" />
            <property name="filename" expression="fn:concat(fn:substring-before($ctx:filename, '.csv'), '.xml')" />
            <property name="transport.vfs.ReplyFileName" expression="$ctx:filename" scope="transport"/>

            <property action="set" name="OUT_ONLY" value="true"/>
            <property name="ClientApiNonBlocking" value="true" scope="axis2" action="remove"/>
            
            <datamapper config="gov:datamapper/schema/mappingconfig.dmc" inputSchema="gov:datamapper/schema/mappingconfig_inputSchema.json" inputType="CSV" outputSchema="gov:datamapper/schema/mappingconfig_outputSchema.json" outputType="XML"/>

            <property name="uri.var.code" expression="$body//items/Code" scope="default" type="STRING"/>
            <property name="uri.var.value" expression="$body//items/Wert" scope="default" type="STRING"/>
            <property name="uri.var.description" expression="$body//items/Beschreibung" scope="default" type="STRING"/>

            <!-- Propagate uri.var.code to OUT_ONLY scope -->
            <property name="uri.var.code" expression="get-property('uri.var.code')" scope="default" action="remove"/>
            <property name="uri.var.code" expression="$ctx:uri.var.code" scope="default" action="set"/>

        </inSequence>
        <outSequence>
            <!-- After completing processing, call the dataservice-proxy -->
            <send>
                <endpoint>
                    <address uri="http://localhost:8080/services/dataservice-proxy"/>
                </endpoint>
            </send>
        </outSequence>
    </target>
</proxy>
